---
sidebar: sidebar 
permalink: task_config_telegraf_agent.html 
keywords: telegraf, installation, install, agent, telegraf agent 
summary: 支援Telegraf作為收集整合資料的代理程式、可在Windows、Linux、MacOS和Kubernetes上設定。Cloud Insights 
---
= 設定代理程式以收集資料
:allow-uri-read: 


[role="lead"]
使用Cloud Insights link:https://docs.influxdata.com/telegraf/v1.19/["Telegraf"] 做為收集整合資料的代理程式。Telegraf是外掛程式導向的伺服器代理程式、可用來收集及報告度量、事件及記錄。輸入外掛程式可透過直接存取系統/作業系統、呼叫協力廠商API或聆聽已設定的串流（例如 卡夫卡、塔斯D等）。輸出外掛程式可用來將收集到的度量、事件和記錄從代理程式傳送至Cloud Insights

目前的Telegraf版本Cloud Insights 是* 1.19.3*。


NOTE: 為確保稽核與資料報告的準確性、強烈建議您使用*網路時間傳輸協定（NTP）*或*簡易網路時間傳輸協定（SNTP）*來同步代理機器上的時間。


NOTE: 如果您想在安裝代理程式之前驗證安裝檔案、請參閱以下的一節 <<Verifying Checksums>>。



== 安裝代理程式

如果您正在安裝服務資料收集器、但尚未設定代理程式、系統會提示您先安裝適當作業系統的代理程式。本主題提供在下列作業系統上安裝Telegraf代理程式的說明：

* <<Windows>>
* <<RHEL and CentOS>>
* <<Ubuntu and Debian>>
* <<macOS>>
* <<Kubernetes>>


若要安裝代理程式、無論您使用的平台為何、都必須先執行下列動作：

. 登入您要用於代理程式的主機。
. 登入Cloud Insights 您的支援網站、前往*管理>資料收集器*。
. 按一下「*+資料收集器*」、然後選擇要安裝的資料收集器。


. 為主機選擇適當的平台（Windows、Linux、MacOS等）
. 請針對每個平台執行其餘步驟。



NOTE: 在主機上安裝代理程式之後、您就不需要在該主機上重新安裝代理程式。


TIP: 在伺服器/ VM上安裝代理程式之後Cloud Insights 、除了從您設定的任何資料收集器收集資料、還會從該系統收集度量資料。這些指標的收集方式如下 link:task_config_telegraf_node.html["「節點」度量"]。


NOTE: 如果您使用的是Proxy、請先閱讀平台的Proxy指示、再安裝Telegraf代理程式。



=== Windows

image:AgentInstallWindows.png["Windows代理程式安裝"]

.先決條件：
* 必須安裝PowerShell
* 如果您使用的是Proxy、請遵循*設定Proxy支援for Windows *一節中的指示。


.在Windows上安裝代理程式的步驟：
. 選擇代理程式存取金鑰。
. 從代理程式安裝對話方塊複製命令區塊。您可以按一下剪貼簿圖示、將命令快速複製到剪貼簿。
. 開啟PowerShell視窗
. 將命令貼到PowerShell視窗中、然後按Enter鍵。
. 命令會下載適當的代理程式安裝程式、安裝並設定預設組態。完成後、它會重新啟動代理程式服務。此命令具有唯一的金鑰、有效時間為24小時。
. 單擊*完成*或*繼續*


安裝代理程式之後、您可以使用下列命令來啟動/停止服務：

....
Start-Service telegraf
Stop-Service telegraf
....


==== 設定適用於Windows的Proxy支援


NOTE: 以下步驟概述設定_https_proxy/https_proxy_環境變數所需的動作。在某些Proxy環境中、使用者可能也需要設定_no_proxyEnvironments _變數。

對於位於Proxy後的系統、請執行下列步驟、設定安裝Telegraf代理程式之前*的_https_proxy_和/或_https_proxy_環境變數：

 [System.Environment]::SetEnvironmentVariable(“https_proxy”, “<proxy_server>:<proxy_port>”, [System.EnvironmentVariableTarget]::Machine)


==== 解除安裝代理程式

若要在Windows上解除安裝代理程式、請在PowerShell視窗中執行下列動作：

. 停止並刪除Telegraf服務：
+
....
Stop-Service telegraf
sc.exe delete telegraf
....
. 從信任來源移除憑證：
+
....
cd Cert:\CurrentUser\Root
rm E5FB7B68C08B1CA902708584C274F8EFC7BE8ABC
....
. 刪除_C:\Program Files\Telewraf_資料夾、以移除二進位檔、記錄檔和組態檔
. 從登錄中移除_system\CurrentControlSet\Services\EventLog\Application\Telewraf_機碼




==== 升級代理程式

若要升級Telewraf代理程式、請執行下列步驟：

. 停止並刪除Telewraf服務：
+
....
Stop-Service telegraf
sc.exe delete telegraf
....
. 從登錄中刪除_system\CurrentControlSet\Services\EventLog\Application\Telewraf_機碼
. 刪除_C:\Program Files\Telewraf\Telewraf.conf
. 刪除_C:\Program Files\Telewraf\Telewraf_exe_
. link:#windows["安裝新代理程式"]。




=== RHEL與CentOS

image:Agent_Requirements_Rhel.png["安裝RHEL/CentOS代理程式"]

.先決條件：
* 下列命令必須可用：curl、Sudo、ping、shav256sum、openssl、 和dmidecode
* 如果您使用的是Proxy、請遵循*設定RHEL/CentOS* Proxy支援一節中的指示。


.在RHEL/CentOS上安裝代理程式的步驟：
. 選擇代理程式存取金鑰。
. 從代理程式安裝對話方塊複製命令區塊。您可以按一下剪貼簿圖示、將命令快速複製到剪貼簿。
. 開啟Bash視窗
. 將命令貼到Bash視窗中、然後按Enter鍵。
. 命令會下載適當的代理程式安裝程式、安裝並設定預設組態。完成後、它會重新啟動代理程式服務。此命令具有唯一的金鑰、有效時間為24小時。
. 單擊*完成*或*繼續*


安裝代理程式之後、您可以使用下列命令來啟動/停止服務：

如果您的作業系統使用systemd（CentOS 7+和RHEL 7+）：

....
sudo systemctl start telegraf
sudo systemctl stop telegraf
....
如果您的作業系統未使用systemd（CentOS 7+和RHEL 7+）：

....
sudo service telegraf start
sudo service telegraf stop
....


==== 設定RHEL/CentOS的Proxy支援


NOTE: 以下步驟概述設定_https_proxy/https_proxy_環境變數所需的動作。在某些Proxy環境中、使用者可能也需要設定_no_proxyEnvironments _變數。

對於位於Proxy之後的系統、請執行下列步驟*先前*、以安裝Telegraf代理程式：

. 為目前使用者設定_https_proxy_和/或_https_proxy_環境變數：
+
 export https_proxy=<proxy_server>:<proxy_port>
. 建立/etc/default/Telegraf_、並插入_https_proxy_和/或_https_proxy_變數的定義：
+
 https_proxy=<proxy_server>:<proxy_port>




==== 解除安裝代理程式

若要在RHEL/CentOS上解除安裝代理程式、請在Bash終端機中執行下列動作：

. 停止Telegraf服務：
+
....
systemctl stop telegraf (If your operating system is using systemd (CentOS 7+ and RHEL 7+)
/etc/init.d/telegraf stop (for systems without systemd support)
....
. 移除Telegraf代理程式：
+
 yum remove telegraf
. 移除可能留下的任何組態或記錄檔：
+
....
rm -rf /etc/telegraf*
rm -rf /var/log/telegraf*
....




==== 升級代理程式

若要升級Telewraf代理程式、請執行下列步驟：

. 停止Telewraf服務：
+
....
systemctl stop telegraf (If your operating system is using systemd (CentOS 7+ and RHEL 7+)
/etc/init.d/telegraf stop (for systems without systemd support)
....
. 移除先前的Telewraf代理程式：
+
 yum remove telegraf
. link:#rhel-and-centos["安裝新代理程式"]。




=== Ubuntu與DEBIAN

image:Agent_Requirements_Ubuntu.png["安裝Ubuntu / Debian代理程式"]

.先決條件：
* 下列命令必須可用：curl、Sudo、ping、shav256sum、openssl、 和dmidecode
* 如果您使用的是Proxy、請依照*設定Ubuntu / DEBIAN*的Proxy支援一節中的指示操作。


.在Debian或Ubuntu上安裝代理程式的步驟：
. 選擇代理程式存取金鑰。
. 從代理程式安裝對話方塊複製命令區塊。您可以按一下剪貼簿圖示、將命令快速複製到剪貼簿。
. 開啟Bash視窗
. 將命令貼到Bash視窗中、然後按Enter鍵。
. 命令會下載適當的代理程式安裝程式、安裝並設定預設組態。完成後、它會重新啟動代理程式服務。此命令具有唯一的金鑰、有效時間為24小時。
. 單擊*完成*或*繼續*


安裝代理程式之後、您可以使用下列命令來啟動/停止服務：

如果您的作業系統使用systemd：

....
sudo systemctl start telegraf
sudo systemctl stop telegraf
....
如果您的作業系統未使用systemd：

....
sudo service telegraf start
sudo service telegraf stop
....


==== 設定Ubuntu / Debian的Proxy支援


NOTE: 以下步驟概述設定_https_proxy/https_proxy_環境變數所需的動作。在某些Proxy環境中、使用者可能也需要設定_no_proxyEnvironments _變數。

對於位於Proxy之後的系統、請執行下列步驟*先前*、以安裝Telegraf代理程式：

. 為目前使用者設定_https_proxy_和/或_https_proxy_環境變數：
+
 export https_proxy=<proxy_server>:<proxy_port>
. 建立/etc/default/Telegraf、並插入_https_proxy_和/或_https_proxy_變數的定義：
+
 https_proxy=<proxy_server>:<proxy_port>




==== 解除安裝代理程式

若要在Ubuntu / Debian上解除安裝代理程式、請在Bash終端機中執行下列作業：

. 停止Telegraf服務：
+
....
systemctl stop telegraf (If your operating system is using systemd)
/etc/init.d/telegraf stop (for systems without systemd support)
....
. 移除Telegraf代理程式：
+
 dpkg -r telegraf
. 移除可能留下的任何組態或記錄檔：
+
....
rm -rf /etc/telegraf*
rm -rf /var/log/telegraf*
....




==== 升級代理程式

若要升級Telewraf代理程式、請執行下列步驟：

. 停止Telewraf服務：
+
....
systemctl stop telegraf (If your operating system is using systemd)
/etc/init.d/telegraf stop (for systems without systemd support)
....
. 移除先前的Telewraf代理程式：
+
 dpkg -r telegraf
. link:#ubuntu-and-debian["安裝新代理程式"]。




=== MacOS

image:Agent_Requirements_Macos.png["安裝MacOS代理程式"]

.先決條件：
* 下列命令必須可用：Curl、Sudo、openssl和shasum
* 如果您使用的是Proxy、請依照*設定MacOS的Proxy支援一節中的指示操作。


.在MacOS上安裝代理程式的步驟：
. 選擇代理程式存取金鑰。
. 從代理程式安裝對話方塊複製命令區塊。您可以按一下剪貼簿圖示、將命令快速複製到剪貼簿。
. 開啟Bash視窗
. 將命令貼到Bash視窗中、然後按Enter鍵。
. 命令會下載適當的代理程式安裝程式、安裝並設定預設組態。完成後、它會重新啟動代理程式服務。此命令具有唯一的金鑰、有效時間為24小時。
. 如果您先前使用homebw安裝Telegraf代理程式、系統會提示您解除安裝。一旦解除安裝先前安裝的Telegraf代理程式、請重新執行上述步驟5中的命令。
. 單擊*完成*或*繼續*


安裝代理程式之後、您可以使用下列命令來啟動/停止服務：

....
sudo launchctl start telegraf
sudo launchctl stop telegraf
....


==== 設定適用於MacOS的Proxy支援


NOTE: 以下步驟概述設定_https_proxy/https_proxy_環境變數所需的動作。在某些Proxy環境中、使用者可能也需要設定_no_proxyEnvironments _變數。

對於位於Proxy後的系統、請執行下列步驟、為目前使用者*安裝Telegraf代理程式之前*設定_https_proxy_和/或_https_proxy_環境變數：

 export https_proxy=<proxy_server>:<proxy_port>
*安裝Telegraf代理程式之後、請在_/Applications/Telegraf.app/Contents / telegraf.plist_:中新增並設定適當的_https_proxy_和/或_https_proxy_變數

....
…
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
   <key>EnvironmentVariables</key>
   <dict>
          <key>https_proxy</key>
          <string><proxy_server>:<proxy_port></string>
   </dict>
   <key>Program</key>
   <string>/Applications/telegraf.app/Contents/MacOS/telegraf</string>
   <key>Label</key>
   <string>telegraf</string>
   <key>ProgramArguments</key>
   <array>
     <string>/Applications/telegraf.app/Contents/MacOS/telegraf</string>
     <string>--config</string>
     <string>/usr/local/etc/telegraf.conf</string>
     <string>--config-directory</string>
     <string>/usr/local/etc/telegraf.d</string>
   </array>
   <key>RunAtLoad</key>
   <true/>
</dict>
</plist>
…
....
然後、在載入上述變更後重新啟動Telegraf：

....
sudo launchctl stop telegraf
sudo launchctl unload -w /Library/LaunchDaemons/telegraf.plist
sudo launchctl load -w /Library/LaunchDaemons/telegraf.plist
sudo launchctl start telegraf
....


==== 解除安裝代理程式

若要在MacOS上解除安裝代理程式、請在Bash終端機中執行下列步驟：

. 停止Telegraf服務：
+
 sudo launchctl stop telegraf
. 解除安裝Telewraf代理程式：
+
....
cp /Applications/telegraf.app/scripts/uninstall /tmp
sudo /tmp/uninstall
....
. 移除可能留下的任何組態或記錄檔：
+
....
rm -rf /usr/local/etc/telegraf*
rm -rf /usr/local/var/log/telegraf.*
....




==== 升級代理程式

若要升級Telewraf代理程式、請執行下列步驟：

. 停止Telewraf服務：
+
 sudo launchctl stop telegraf
. 解除安裝先前的Telewraf代理程式：
+
....
cp /Applications/telegraf.app/scripts/uninstall /tmp
sudo /tmp/uninstall
....
. link:#macos["安裝新代理程式"]。




=== Kubernetes

Kubernetes提供兩種收集資料的方法：

* NetApp Kubernetes監控操作員組態。這是Kubernetes的建議安裝方法。
* 傳統的指令碼型代理程式安裝


安裝說明視您選擇的項目而有所不同。

image:Kubernetes_Operator_Tile_Choices.png["Kubernetes安裝選項"]


NOTE: NetApp Kubernetes監控操作員安裝被視為_Preview_功能、因此可能會有所變更。

.先決條件：
* 下列命令必須可用：curl、Sudo、openssl、shavosum和kuvecl
+
若要獲得最佳結果、請將這些命令新增至路徑。

* 必須安裝Kube-state指標。如需詳細資訊、請參閱下方。Kube-state指標會隨著以操作員為基礎的安裝而自動安裝。
* 如果您使用的是Proxy、請遵循*設定Kubernetes*的Proxy支援一節中的指示。
* 如果您執行的Kubernetes變體需要安全性內容限制、請遵循*設定代理程式從Kubernetes*收集資料一節中的指示。以營運者為基礎的安裝會為您安裝。
* 您必須擁有建立Kubernetes叢集角色和角色繫結的權限。
* NetApp Kubernetes監控操作員安裝已通過測試、預期可與AWS EKS 1.18、OpenShift 3.11和Rancher 2.6搭配使用。




==== 監控功能僅安裝在Linux節點上

支援監控執行Linux的Kubernetes節點、方法是指定Kubernetes節點選取器、在這些平台上尋找下列Kubernetes標籤：Cloud Insights

|===
| 平台 | 標籤 


| Kubernetes v1.17及更新版本 | Kubernetes.IO/OS = Linux 


| Rancher + Catchs.IO做為協調/ Kubernetes平台 | Catin.IO/OS = Linux 
|===


==== NetApp Kubernetes監控操作員安裝

image:Kubernetes_Operator_Agent_Instructions.png["以操作者為基礎的安裝"]

.在Kubernetes上安裝NetApp Kubernetes監控操作員代理程式的步驟：
. 輸入叢集名稱和命名空間。
. 一旦輸入這些程式碼、您就可以複製代理程式安裝程式程式片段
. 按一下按鈕、將此片段複製到剪貼簿。
. 將程式碼片段貼到_bash_視窗中並執行。
. 安裝會自動繼續進行。完成後、按一下「完成設定」按鈕。




==== 為NetApp Kubernetes監控操作員設定Proxy支援

若要為監控操作員設定Proxy、請執行下列步驟。

首先、開啟_agent-監 控-NetApp_檔案進行編輯：

 kubectl -n netapp-monitoring edit agent agent-monitoring-netapp
在此檔案的_spec__區段中、新增下列程式碼區塊：

....
spec:
  proxy:
    isAuProxyEnabled: <true or false>
    isTelegrafProxyEnabled: <true or false>
    isFluentbitProxyEnabled: <true or false>
    password: <password for proxy, optional>
    port: <port for proxy>
    server: <server for proxy>
    username: <username for proxy, optional>
    noProxy: <comma separated list of IPs or resolvable hostnames that should bypass a proxy>
....


===== 使用自訂/私有泊塢視窗儲存庫

如果使用自訂泊塢視窗儲存庫、請執行下列動作：

取得Docker密碼：

 kubectl -n netapp-monitoring get secret docker -o yaml
從上述命令的輸出中複製/貼上_.dockerconfigjson__的值。

解碼Docker機密：

 echo <paste from _.dockerconfigjson:_  output above> | base64 -d
此輸出將採用下列json格式：

....
{ "auths":
  {"docker.<cluster>.cloudinsights.netapp.com" :
    {"username":"<tenant id>",
     "password":"<password which is the CI API key>",
     "auth"    :"<encoded username:password basic auth key. This is internal to docker>"}
  }
}
....
登入Docker儲存庫：

....
docker login docker.<cluster>.cloudinsights.netapp.com (from step #2) -u <username from step #2>
password: <password from docker secret step above>
....
從Cloud Insights 「畫面」中拉出「運算子」泊塢視窗影像：

 docker pull docker.<cluster>.cloudinsights.netapp.com/netapp-monitoring:<version>
使用下列命令尋找<版本>欄位：

 kubectl -n netapp-monitoring get deployment monitoring-operator | grep "image:"
根據您的企業原則、將「operator」泊塢視窗影像推送到您的「私有/本機/企業」泊塢視窗儲存庫。

將所有開放原始碼相依性下載到您的Private Docker登錄。需要下載下列開放原始碼映像：

....
docker.io/telegraf:1.19.3
gcr.io/kubebuilder/kube-rbac-proxy:v0.5.0
k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.1.0
....
如果已啟用Fluent位元、請同時下載：

....
docker.io/fluent-bit:1.7.8
docker.io/kubernetes-event-exporter:0.10
....
編輯代理程式CR以反映新的Docker repo位置、停用自動升級（若已啟用）。

 kubectl -n netapp-monitoring edit agent agent-monitoring-netapp
 enableAutoUpgrade: false
....
docker-repo: <docker repo of the enterprise/corp docker repo>
dockerRepoSecret: <optional: name of the docker secret of enterprise/corp docker repo, this secret should be already created on the k8s cluster in the same namespace>
....
在_spec__區段中、進行下列變更：

....
spec:
  telegraf:
    - name: ksm
      substitutions:
        - key: k8s.gcr.io
          value: <same as "docker-repo" field above>
....


==== 指令碼型安裝

image:Kubernetes_Install_Agent_screen.png["指令碼型安裝"]

.在Kubernetes上安裝指令碼型代理程式的步驟：
. 選擇代理程式存取金鑰。
. 按一下安裝對話方塊中的*複製代理程式安裝程式片段*按鈕。若要檢視命令區塊、您可以選擇按一下「+顯示代理程式安裝程式的程式碼片段_」按鈕。
. 將命令貼到_bash_視窗。
. 或者、您可以修改命令區塊、在最終版本的_.//$installerName_之前新增下列其中一項或兩項、以覆寫命名空間或提供叢集名稱做為install命令的一部分
+
** Cluster_name=
** 命名空間=
+
它位於命令區塊中：

+
 installerName=cloudinsights-kubernetes.sh ... && CLUSTER_NAME=<cluster_name> NAMESPACE=<new_namespace> sudo -E -H ./$installerName --download --install
+

TIP: _叢集名稱_是Cloud Insights 來自於Estres收集 度量的Kubernetes叢集名稱、而_names_是部署Telegraf代理程式的命名空間。如果指定的命名空間不存在、將會建立該命名空間。



. 準備好之後、請執行命令區塊。
. 命令會下載適當的代理程式安裝程式、安裝並設定預設組態。如果您尚未明確設定_namespace_、系統會提示您輸入。完成後、指令碼會重新啟動代理程式服務。此命令具有唯一的金鑰、有效時間為24小時。
. 完成後、按一下*完成設定*。




==== 設定Kubernetes的Proxy支援-指令碼型


NOTE: 以下步驟概述設定_https_proxy/https_proxy_環境變數所需的動作。在某些Proxy環境中、使用者可能也需要設定_no_proxyEnvironments _變數。

對於位於Proxy後的系統、請執行下列步驟、為目前使用者*安裝Telegraf代理程式之前*設定_https_proxy_和/或_https_proxy_環境變數：

 export https_proxy=<proxy_server>:<proxy_port>
*安裝Telegraf代理程式之後、將適當的_https_proxy_和/或_https_proxy_環境變數新增並設定至_Telegraf-ds_取消保護套件和_Telegraf-rs_複本。

 kubectl edit ds telegraf-ds
....
…
       env:
       - name: https_proxy
         value: <proxy_server>:<proxy_port>
       - name: HOSTIP
         valueFrom:
           fieldRef:
             apiVersion: v1
             fieldPath: status.hostIP
…
....
 kubectl edit rs telegraf-rs
....
…
       env:
       - name: https_proxy
         value: <proxy_server>:<proxy_port>
       - name: HOSTIP
         valueFrom:
           fieldRef:
             apiVersion: v1
             fieldPath: status.hostIP
…
....
然後重新啟動Telegraf：

....
kubectl delete pod telegraf-ds-*
kubectl delete pod telegraf-rs-*
....


==== 示範設定、複本集、以及停止/啟動代理程式

將在Kubernetes叢集上建立示範集和複製集、以執行所需的Telegraf代理程式/ Pod。根據預設、這些Telegraf代理程式/ Pod會排程在主要和非主要節點上。

若要協助停止及重新啟動代理程式、請使用下列命令產生Telegraf示範設定Yaml和ReplicaSet Yaml。請注意、這些命令使用的是預設命名空間「CI監控」。如果您已設定自己的命名空間、請在這些及所有後續命令與檔案中取代該命名空間：

如果您已設定自己的命名空間、請在這些及所有後續命令與檔案中取代該命名空間：

....
kubectl --namespace ci-monitoring get ds telegraf-ds -o yaml > /tmp/telegraf-ds.yaml
kubectl --namespace ci-monitoring get rs telegraf-rs -o yaml > /tmp/telegraf-rs.yaml
....
然後、您可以使用下列命令來停止及啟動Telegraf服務：

....
kubectl --namespace ci-monitoring delete ds telegraf-ds
kubectl --namespace ci-monitoring delete rs telegraf-rs
....
....
kubectl --namespace ci-monitoring apply -f /tmp/telegraf-ds.yaml
kubectl --namespace ci-monitoring apply -f /tmp/telegraf-rs.yaml
....


==== 設定代理程式從Kubernetes收集資料

附註：指令碼型安裝的預設命名空間為_CI-監 控_。對於基於操作員的安裝、預設命名空間為_NetApp-監 控_。在涉及命名空間的命令中、請務必為安裝指定正確的命名空間。

執行代理程式的Pod需要存取下列項目：

* 主機路徑
* 組態對應
* 機密


這些Kubernetes物件會自動建立、做為Kubernetes代理程式安裝命令的一部分、此命令會在Cloud Insights 支援者介面中提供。Kubernetes的某些變種（例如OpenShift）會實作額外的安全層級、以封鎖對這些元件的存取。_SecurityContextConstraint_不是以Kubernetes代理程式安裝命令的一部分建立Cloud Insights 、此命令是以人工方式建立。建立後、重新啟動Telegraf Pod。

[listing]
----
    apiVersion: v1
    kind: SecurityContextConstraints
    metadata:
      name: telegraf-hostaccess
      creationTimestamp:
      annotations:
        kubernetes.io/description: telegraf-hostaccess allows hostpath volume mounts for restricted SAs.
      labels:
        app: ci-telegraf
    priority: 10
    allowPrivilegedContainer: true
    defaultAddCapabilities: []
    requiredDropCapabilities: []
    allowedCapabilities: []
    allowedFlexVolumes: []
    allowHostDirVolumePlugin: true
    volumes:
    - hostPath
    - configMap
    - secret
    allowHostNetwork: false
    allowHostPorts: false
    allowHostPID: false
    allowHostIPC: false
    seLinuxContext:
      type: MustRunAs
    runAsUser:
      type: RunAsAny
    supplementalGroups:
      type: RunAsAny
    fsGroup:
      type: RunAsAny
    readOnlyRootFilesystem: false
    users:
    - system:serviceaccount:ci-monitoring:monitoring-operator
    groups: []
----


==== 安裝kube狀態度量伺服器


NOTE: 以營運者為基礎的安裝會處理kube狀態指標的安裝。如果您執行的是以操作員為基礎的安裝、請跳過本節。


NOTE: 強烈建議使用Kube-state度量2.0版或更新版本、以充分利用完整功能集、包括將Kubernetes持續磁碟區（PV）連結至後端儲存裝置的功能。另請注意、使用Kube-state度量2.0版及更新版本時、Kubernetes物件標籤預設不會匯出。若要設定Kube-state度量以匯出Kubernetes物件標籤、您必須指定度量標籤「允許」清單。請參閱中的「」-「metric - label - owlist_」（公制標籤-允許清單_）選項 link:https://github.com/kubernetes/kube-state-metrics/blob/master/docs/cli-arguments.md["Kube-state指標文件"]。

請使用下列步驟安裝kube狀態度量伺服器（執行指令碼型安裝時需要）：

.步驟
. 建立暫用資料夾（例如：//tmp/kube-n態-yaml-files/_）、然後從複製.yaml檔案 https://github.com/kubernetes/kube-state-metrics/tree/master/examples/standard[] 至此資料夾。
. 執行下列命令以套用安裝Kusbe-態 度量所需的.yaml檔案：
+
 kubectl apply -f /tmp/kube-state-yaml-files/




==== Kube-state指標計數器

請使用下列連結來存取Kube狀態度量計數器的資訊：

. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/configmap-metrics.md["ConfigMap指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/daemonset-metrics.md["示範設定指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/deployment-metrics.md["部署指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/ingress-metrics.md["入口指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/namespace-metrics.md["命名空間度量"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/node-metrics.md["節點度量"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolume-metrics.md["持續Volume指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolumeclaim-metrics.md["持續Volume報銷標準"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/pod-metrics.md["Pod指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/replicaset-metrics.md["ReplicaSet度量"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/secret-metrics.md["機密數據"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/service-metrics.md["服務指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/statefulset-metrics.md["StatefulSet指標"]




==== 解除安裝代理程式

請注意、這些命令使用的是預設命名空間「CI監控」。如果您已設定自己的命名空間、請在這些名稱空間以及所有後續命令和檔案中取代該命名空間。

若要在Kubernetes上解除安裝以指令碼為基礎的代理程式、請執行下列步驟：

如果監控命名空間僅用於Telegraf：

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
 kubectl delete ns ci-monitoring
如果監控命名空間用於Telegraf以外的其他用途：

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
針對以操作員為基礎的安裝、請執行下列命令：

....
kubectl delete ns netapp-monitoring
kubectl delete agent agent-monitoring-netapp
kubectl delete crd agents.monitoring.netapp.com
kubectl delete role agent-leader-election-role
kubectl delete clusterrole agent-manager-role agent-proxy-role agent-metrics-reader
kubectl delete clusterrolebinding agent-manager-rolebinding agent-proxy-rolebinding agent-cluster-admin-rolebinding
....
如果先前已手動為指令碼型Telegraf安裝建立安全內容限制：

 kubectl delete scc telegraf-hostaccess


==== 升級代理程式

請注意、這些命令使用的是預設命名空間「CI監控」。如果您已設定自己的命名空間、請在這些名稱空間以及所有後續命令和檔案中取代該命名空間。

若要升級Telewraf代理程式、請執行下列步驟：

. 備份現有組態：
+
 kubectl --namespace ci-monitoring get cm -o yaml > /tmp/telegraf-configs.yaml


. 解除安裝代理程式（請參閱上述說明）
. link:#kubernetes["安裝新代理程式"]。




== 驗證Checksum

雖然無法執行完整性檢查、Cloud Insights 但有些使用者可能想在安裝或套用下載的成品之前、先執行自己的驗證。若要執行純下載作業（而非預設的下載與安裝）、這些使用者可以編輯從UI取得的代理程式安裝命令、並移除後續的「install」選項。

請遵循下列步驟：

. 依照指示複製代理程式安裝程式程式片段。
. 不要將程式碼片段貼到命令視窗中、而是貼到文字編輯器中。
. 從命令中刪除後端"--install"（Linux/Mac）或"-install"（Windows）。
. 從文字編輯器複製整個命令。
. 現在請將其貼到命令視窗（工作目錄）中、然後執行。


非Windows（這些範例適用於Kubernetes；實際的指令碼名稱可能有所不同）：

* 下載並安裝（預設）：
+
 installerName=cloudinsights-kubernetes.sh … && sudo -E -H ./$installerName --download –-install
* 僅限下載：
+
 installerName=cloudinsights-kubernetes.sh … && sudo -E -H ./$installerName --download


Windows：

* 下載並安裝（預設）：
+
 !$($installerName=".\cloudinsights-windows.ps1") … -and $(&$installerName -download -install)
* 僅限下載：
+
 !$($installerName=".\cloudinsights-windows.ps1") … -and $(&$installerName -download)


純下載命令會將Cloud Insights 所有必要的成品從功能性資訊下載到工作目錄。這些成品包括但不限於：

* 安裝指令碼
* 環境檔案
* Y反 洗錢檔案
* 簽署的Checksum檔案（sh256.signed）
* 用於簽名驗證的一個PES檔案（NetApp_CERT.pem）


安裝指令碼、環境檔案及Yaml檔案均可使用目視檢查進行驗證。

您可以確認其指紋為下列項目、以驗證該PEM檔案：

 E5:FB:7B:68:C0:8B:1C:A9:02:70:85:84:C2:74:F8:EF:C7:BE:8A:BC
更具體地說、

* 非Windows：
+
 openssl x509 -fingerprint -sha1 -noout -inform pem -in netapp_cert.pem
* Windows：
+
 Import-Certificate -Filepath .\netapp_cert.pem -CertStoreLocation Cert:\CurrentUser\Root


簽署的Checksum檔案可以使用PEM檔案進行驗證：

* 非Windows：
+
 openssl smime -verify -in sha256.signed -CAfile netapp_cert.pem -purpose any
* Windows（透過上述匯入憑證安裝憑證之後）：
+
 Get-AuthenticodeSignature -FilePath .\sha256.ps1 $result = Get-AuthenticodeSignature -FilePath .\sha256.ps1 $signer = $result.SignerCertificate Add-Type -Assembly System.Security [Security.Cryptography.x509Certificates.X509Certificate2UI]::DisplayCertificate($signer)


一旦所有成品都已通過驗證、即可執行下列步驟來啟動代理程式安裝：

非Windows：

 sudo -E -H ./<installation_script_name> --install
Windows：

 .\cloudinsights-windows.ps1 -install


== 代理程式安裝疑難排解

如果您在設定代理程式時遇到問題、請嘗試下列事項：

[cols="2*"]
|===
| 問題： | 試用： 


| 我已經用Cloud Insights 了這個功能來安裝代理程式 | 如果您已在主機/ VM上安裝代理程式、則不需要重新安裝代理程式。在這種情況下、只要在「代理程式安裝」畫面中選擇適當的平台和金鑰、然後按一下*繼續*或*完成*即可。 


| 我已經安裝了代理程式、但沒有使用Cloud Insights 這個安裝程式 | 移除先前的代理程式並執行Cloud Insights 安裝程序、以確保預設的組態檔設定正確無誤。完成後、按一下*繼續*或*完成*。 


| 我看不到Kubernetes持續Volume與對應的後端儲存設備之間的超連結/連線。我的Kubernetes持續Volume是使用儲存伺服器的主機名稱來設定。 | 請依照步驟解除安裝現有的Telegraf代理程式、然後重新安裝最新的Telegraf代理程式。您必須使用Telegraf 2.0版或更新版本。 


| 我在記錄中看到類似以下內容的訊息：E0901 15：21：39.962145 1反射器.go：178] k8s.io/kube狀態指標/內部/儲存區/建置者。Go：無法列出* v1.matingWebhookkConfiguration：伺服器找不到所要求的資源E0901 15：21：43.352/16ku.16178.16v1.資源搜尋失敗kuo.16178. | 如果您執行Kubernetes 1.17版或更低版本的Kubernetes狀態指標2.0.0版或更高版本、就可能會出現這些訊息。若要取得Kubernetes版本：_kubeclt版本_若要取得Kube-st態 度量版本：_kubeclt Get Deploy / kube-state-metases -o jsonpath='{.image}'_若要避免發生這些訊息、使用者可以修改其kube-state-metases部署、以停用下列Les:_mutatingwebhookwebhookvalidkap_props_enefroup參數組態： resources=certicatesignquests、水平複製、組態、cronjobs、取消套用、部署、端點、橫向套用自動擴充、擷取、工作、限制範圍、命名空間、網路原則、節點、持續套用磁碟區、持續套用磁碟區、資源資源等、機密、服務、服務、網路套用原則、預設套用範圍、重複本、複本、複製、資源、套用、資源、限制、資源組、資源、資源組態、資源、儲存、預設值、資源、限制、資源、資源、儲存、組態設定、儲存、儲存、儲存、限制、資源、資源、資源、儲存區、限制、資源、資源、資源、資源、儲存區、資源、限制、資源、資源、資源、儲存區、限制、儲存區、資源組態設定、資源、儲存區、資源、資源、儲存區、資源、資源、資源、儲存區、儲存區、資源、資源、資源、資源、資源、資源、 驗證webhookconfigurations、volume附件" 


| 我在Kubernetes上安裝或升級Telegraf、但Telegraf Pod無法啟動。Telegraf ReplicaSet或demonSet報告類似下列的故障：建立錯誤：Pod「Telegraf-rs-」被禁止」：無法針對任何安全內容限制進行驗證：[spec.Volumes[2]：無效值：「hostPath」：不允許使用hostPath磁碟區] | 如果安全內容限制尚未存在、請建立安全內容限制（請參閱上述「設定代理程式以從Kubernetes收集資料」一節）。確保安全內容限制所指定的命名空間和服務帳戶符合Telegraf ReplicaSet和示範Set的命名空間和服務帳戶。KVECTL說明SCC Telegraf-hostaccess | grep ServiceAccount kubecln CI-Monitoring -說明RS Telegraf-RS | grep -I "Namespace:" kbecln CI-Monitoring說明RS Telegraf-RS | grep -I "Service Accounts"" Kustreve-n CI-Monitoring： 


| 我看到Telegraf發出的錯誤訊息類似於下列內容、但Telegraf確實會啟動並執行：10月11日14：23：41 IP：172-31：39 - 47系統d[1]：啟動外掛程式導向的伺服器代理程式、以便向影響者xDB報告指標。10月11日14：23：41 IP-172-31-39-47 Telewraf[1827]：Times="2021：10-11T14：23：41Z" level =錯誤msg="failed to create cache directory./etc/telegraf/.cache / snowflake、err：mkdir /etc/telegraf/.ca Che：權限遭拒。ignored\n" func="gosnowflake.（*預設Logger）.Errorf" file="log.go:120" OCT 11 14：23：41 IP：172-31：39：47 Telefraf[1827]：Times="2021：10-11T14：23：41Z" level =錯誤msg=「無法開啟。忽略。開啟/etc/telegraf/.cache / snowflake/occs_rapping_cache。json：沒有這樣的檔案或目錄。\n" func="gosunflake.（*預設Logger）.rf" file="log.go:120" 10月11日14：23：41 IP：172-31：39 - 47 Telefraf[1827]：10-1014：T1114：10！啟動Telegraf 1.19.3 | 這是已知的問題。請參閱 link:https://github.com/influxdata/telegraf/issues/9407["這篇GitHub文章"] 以取得更多詳細資料。只要Telegraf已啟動且正在執行、使用者就可以忽略這些錯誤訊息。 


| 在Kubernetes上、我的Telegraf pod報告下列錯誤：「處理mountstats資訊時發生錯誤：無法開啟mountstats檔案：/hostfs/proc/1/mountstats、錯誤：開啟/hostfs/proc/1/mountstats：權限遭拒」 | 如果啟用並強制實施SELinux、可能會使Telegraf pod無法存取Kubernetes節點上的/proc/1/mountstats檔案。若要放寬此限制、請執行下列其中一項：•針對指令碼型安裝、編輯Telewraf DS（'kubeclt editing DS Telefra-DS'）、並將「特權：假」變更為「特殊權限：真」•針對以操作員為基礎的安裝、編輯代理程式（'kubeclt edit代理 程式監控-NetApp'）、並將「特殊權限模式：假」變更為真： 
|===
如需其他資訊、請參閱 link:concept_requesting_support.html["支援"] 頁面或中的 link:https://docs.netapp.com/us-en/cloudinsights/CloudInsightsDataCollectorSupportMatrix.pdf["資料收集器支援對照表"]。
